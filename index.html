<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Backroom 2026 1.0</title>
    <style>
        /* ==================== å®Œå…¨ä¿ç•™ä¹‹å‰çš„æ ·å¼ ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Arial', sans-serif;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #d4c541;
        }

        /* å¯åŠ¨ç•Œé¢ */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #d4c541;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #start-screen h1 {
            font-size: clamp(3rem, 15vw, 6rem);
            color: black;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 3rem;
            text-shadow: 4px 4px 0 rgba(0,0,0,0.2);
            text-align: center;
        }

        .start-options {
            display: flex;
            gap: 3rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .start-btn {
            font-size: clamp(2rem, 6vw, 3rem);
            padding: 1.2rem 3rem;
            background: black;
            color: white;
            border: none;
            border-radius: 4rem;
            cursor: pointer;
            box-shadow: 0 8px 0 #5a4e2b;
            transition: transform 0.1s, box-shadow 0.1s;
            min-width: 240px;
            font-weight: bold;
        }

        .start-btn:active {
            transform: translateY(8px);
            box-shadow: none;
        }

        /* é€šç”¨é¢æ¿ */
        .panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #d4c541;
            display: none;
            z-index: 900;
            padding: 2rem;
            overflow-y: auto;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .panel-header h2 {
            font-size: clamp(2rem, 6vw, 2.8rem);
            color: black;
        }

        .back-btn {
            font-size: 1.5rem;
            padding: 0.6rem 2rem;
            background: black;
            color: white;
            border: none;
            border-radius: 3rem;
            cursor: pointer;
        }

        /* å·¦å³åˆ†æ  */
        .split {
            display: flex;
            gap: 2rem;
            height: calc(100% - 6rem);
            flex-wrap: wrap;
        }

        .left-col, .right-col {
            flex: 1 1 300px;
            background: rgba(0,0,0,0.1);
            border-radius: 2rem;
            padding: 1.5rem;
            overflow-y: auto;
            min-width: 250px;
        }

        .col-title {
            font-size: 1.8rem;
            color: black;
            margin-bottom: 1rem;
            text-align: center;
            border-bottom: 2px solid black;
            padding-bottom: 0.5rem;
        }

        /* å­˜æ¡£é¡¹ */
        .save-item {
            background: rgba(255,255,255,0.3);
            border-radius: 1rem;
            margin-bottom: 1rem;
            border: 2px solid black;
            overflow: hidden;
        }

        .save-content {
            display: flex;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .save-content:hover {
            background: rgba(255,255,255,0.5);
        }

        .save-info {
            flex: 1;
        }

        .save-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: black;
        }

        .save-detail {
            font-size: 0.9rem;
            color: #333;
            margin-top: 0.3rem;
        }

        .save-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: 0.5rem;
        }

        .action-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: black;
            color: white;
            border: 2px solid #5a4e2b;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s, background 0.1s;
        }

        .action-btn:active {
            transform: scale(0.9);
        }

        .delete-btn {
            background: #aa2222;
        }

        .copy-btn {
            background: #2266aa;
        }

        /* æ–°å»ºæ¸¸æˆ */
        .new-game-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
            border: 2px solid black;
            border-radius: 2rem;
            background: rgba(255,255,255,0.5);
            margin-bottom: 1rem;
            outline: none;
        }

        .new-game-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.5rem;
            background: black;
            color: white;
            border: none;
            border-radius: 3rem;
            cursor: pointer;
        }

        /* ç§æœ‰æœåŠ¡å™¨åŒºåŸŸ - æ–°å¢ */
        .private-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .plus-btn {
            width: 6rem;
            height: 6rem;
            background: black;
            color: #d4c541;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            cursor: pointer;
            margin-bottom: 2rem;
            transition: transform 0.2s;
            border: 4px solid #5a4e2b;
        }

        .plus-btn:active {
            transform: scale(0.9);
        }

        .private-options {
            display: none;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 300px;
        }

        .private-options button {
            padding: 1rem;
            font-size: 1.4rem;
            background: black;
            color: white;
            border: none;
            border-radius: 3rem;
            cursor: pointer;
        }

        /* å…¬å¼€æœåŠ¡å™¨åˆ—è¡¨ - æ–°å¢ */
        .server-item {
            background: rgba(255,255,255,0.3);
            border-radius: 1rem;
            margin-bottom: 1rem;
            border: 2px solid black;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .server-item:hover {
            background: rgba(255,255,255,0.5);
        }

        .server-info {
            flex: 1;
        }

        .server-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: black;
        }

        .server-players {
            font-size: 1rem;
            color: #333;
            margin-top: 0.3rem;
        }

        .join-indicator {
            font-size: 1.2rem;
            color: black;
            margin-left: 1rem;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: #d4c541;
            border: 4px solid black;
            border-radius: 2rem;
            padding: 2rem;
            width: 90%;
            max-width: 350px;
        }

        .modal-content h3 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: black;
        }

        .modal-content input {
            width: 100%;
            padding: 1rem;
            margin: 0.5rem 0 1rem;
            border: 2px solid black;
            border-radius: 2rem;
            font-size: 1rem;
            background: rgba(255,255,255,0.5);
            outline: none;
        }

        .modal-content button {
            width: 100%;
            padding: 1rem;
            background: black;
            color: white;
            border: none;
            border-radius: 3rem;
            font-size: 1.2rem;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .modal-content .cancel-btn {
            background: #666;
            margin-top: 0.5rem;
        }

        /* æ¸¸æˆå®¹å™¨ */
        #game-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 500;
        }

        #game-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }

        /* èŠå¤©æ¡† - æ–°å¢ */
        #chat-container {
            position: absolute;
            bottom: 100px;
            right: 20px;
            width: 300px;
            max-height: 200px;
            background: rgba(255, 255, 0, 0.3);
            border: 2px solid black;
            border-radius: 10px;
            display: none;
            flex-direction: column;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        #chat-messages {
            flex: 1;
            padding: 5px;
            overflow-y: auto;
            font-size: 14px;
            color: black;
            max-height: 150px;
        }

        #chat-input-area {
            display: flex;
            border-top: 1px solid black;
        }

        #chat-input {
            flex: 1;
            padding: 5px;
            background: transparent;
            border: none;
            outline: none;
            color: black;
            font-size: 14px;
        }

        #chat-send {
            background: black;
            color: #d4c541;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }

        

        #deathOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0044aa;
            display: none;
            z-index: 10000;
            pointer-events: none;
        }
    </style>

    <!-- å¼•å…¥ PeerJS ç”¨äºå¤šäººè”æœº -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <!-- ç®€å•èµ·è§ï¼Œä¸ä½¿ç”¨ Firebaseï¼Œç”¨å†…å­˜æ¨¡æ‹Ÿå…¬å¼€æœåŠ¡å™¨åˆ—è¡¨ -->
</head>
<body>
    <!-- å¯åŠ¨ç•Œé¢ -->
    <div id="start-screen">
        <h1>BACKROOM 2026 1.0</h1>
        <div class="start-options">
            <button class="start-btn" id="singleplayer-btn">å•äººæ¸¸æˆ</button>
            <button class="start-btn" id="multiplayer-btn">å¤šäººæ¸¸æˆ</button>
        </div>
    </div>

    <!-- å•äººæ¸¸æˆé¢æ¿ -->
    <div id="singleplayer-panel" class="panel">
        <div class="panel-header">
            <h2>å•äººæ¸¸æˆ</h2>
            <button class="back-btn" id="back-from-single">è¿”å›</button>
        </div>
        <div class="split">
            <div class="left-col">
                <div class="col-title">å·²æœ‰æ¸¸æˆ</div>
                <div id="save-list"></div>
            </div>
            <div class="right-col">
                <div class="col-title">åˆ›å»ºæ–°æ¸¸æˆ</div>
                <input type="text" id="new-game-name" class="new-game-input" placeholder="è¾“å…¥æ¸¸æˆåç§°" maxlength="20">
                <button class="new-game-btn" id="start-new-game">å¼€å§‹æ¸¸æˆ</button>
            </div>
        </div>
    </div>

    <!-- å¤šäººæ¸¸æˆé¢æ¿ - ä¿ç•™åŸæ ·ï¼Œæ·»åŠ ç§æœ‰/å…¬å¼€æœåŠ¡å™¨ -->
    <div id="multiplayer-panel" class="panel">
        <div class="panel-header">
            <h2>å¤šäººæ¸¸æˆ</h2>
            <button class="back-btn" id="back-from-multi">è¿”å›</button>
        </div>
        <div class="split">
            <div class="left-col">
                <div class="col-title">ğŸ”’ ç§æœ‰æœåŠ¡å™¨</div>
                <div class="private-area">
                    <div class="plus-btn" id="private-plus">+</div>
                    <div id="private-options" class="private-options">
                        <button id="create-private">åˆ›å»ºç§æœ‰æœåŠ¡å™¨</button>
                        <button id="join-private">åŠ å…¥ç§æœ‰æœåŠ¡å™¨</button>
                    </div>
                </div>
            </div>
            <div class="right-col">
                <div class="col-title">ğŸŒ å…¬å¼€æœåŠ¡å™¨</div>
                <div style="margin-bottom: 1rem; text-align: center;">
                    <button class="new-game-btn" id="create-public" style="width: auto; padding: 0.8rem 2rem;">+ åˆ›å»ºå…¬å¼€æˆ¿é—´</button>
                </div>
                <div id="public-server-list"></div>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆå®¹å™¨ -->
    <div id="game-container">
        <iframe id="game-frame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"></iframe>
        <div id="chat-container">
            <div id="chat-messages"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="è¯´ç‚¹ä»€ä¹ˆ...">
                <button id="chat-send">å‘é€</button>
            </div>
        </div>
        
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="id-modal" class="modal">
        <div class="modal-content">
            <h3>è¾“å…¥ä½ çš„ID</h3>
            <input type="text" id="player-id-input" placeholder="ä¾‹å¦‚: æ¢é™©å®¶" value="ç©å®¶">
            <p id="id-error" style="color: red; font-size: 0.9rem; display: none;">ä¸èƒ½åŒ…å«â€œä¿Šæºâ€</p>
            <button id="confirm-id">ç¡®è®¤</button>
            <button class="cancel-btn" id="cancel-id">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="create-private-modal" class="modal">
        <div class="modal-content">
            <h3>åˆ›å»ºç§æœ‰æœåŠ¡å™¨</h3>
            <input type="text" id="private-room-name" placeholder="æˆ¿é—´åç§°" maxlength="20">
            <input type="password" id="private-password" placeholder="å¯†ç ">
            <button id="confirm-create-private">åˆ›å»º</button>
            <button class="cancel-btn" id="cancel-create-private">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="join-private-modal" class="modal">
        <div class="modal-content">
            <h3>åŠ å…¥ç§æœ‰æœåŠ¡å™¨</h3>
            <input type="password" id="join-password" placeholder="å¯†ç ">
            <button id="confirm-join-private">åŠ å…¥</button>
            <button class="cancel-btn" id="cancel-join-private">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="create-public-modal" class="modal">
        <div class="modal-content">
            <h3>åˆ›å»ºå…¬å¼€æˆ¿é—´</h3>
            <input type="text" id="public-room-name" placeholder="æˆ¿é—´åç§°" maxlength="20">
            <button id="confirm-create-public">åˆ›å»º</button>
            <button class="cancel-btn" id="cancel-create-public">å–æ¶ˆ</button>
        </div>
    </div>
          <div id="create-public-modal" class="modal">
    <div class="modal-content">
        <h3>åˆ›å»ºå…¬å¼€æˆ¿é—´</h3>
        <input type="text" id="public-room-name" placeholder="æˆ¿é—´åç§°" maxlength="20">
        <button id="confirm-create-public">åˆ›å»º</button>
        <button class="cancel-btn" id="cancel-create-public">å–æ¶ˆ</button>
    </div>
</div>

<!-- æ–°å¢ï¼šæˆ¿é—´IDæ˜¾ç¤ºæ¨¡æ€æ¡† -->
<div id="room-id-modal" class="modal">
    <div class="modal-content">
        <h3>ğŸ® æˆ¿é—´åˆ›å»ºæˆåŠŸ</h3>
        <p style="margin: 1rem 0;">æˆ¿é—´åç§°: <strong id="display-room-name"></strong></p>
        <p>æˆ¿é—´ID: <strong id="display-room-id" style="font-size: 1.5rem; color: #aa2222;"></strong></p>
        <p style="margin: 1rem 0;">å¯†ç : <strong id="display-room-pwd"></strong></p>
        <p style="font-size: 0.9rem; color: #333;">æŠŠè¿™ä¸ªIDå’Œå¯†ç å‘Šè¯‰ä½ çš„æœ‹å‹</p>
        <button id="copy-room-id" style="background: #2266aa; width: 100%; padding: 1rem; margin-bottom: 0.5rem;">å¤åˆ¶ID</button>
        <button class="cancel-btn" id="close-room-modal" style="width: 100%;">ç¡®å®š</button>
    </div>
</div>

    <div id="deathOverlay"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        (function() {
            "use strict";

            // ---------- å…³å¡é¡ºåº ----------
            const LEVELS = [
                'level0.html',
                'Level1.html',
                'level2.html',
                'Level fun.html',
                'level2.html',
                'level3.html',
                'Level4.html',
                'Level9999.html',
                'Level94.html',
                'Level!.html'
            ];

            // å½“å‰æ¸¸æˆçŠ¶æ€
            const gameState = {
                currentGameType: null,      // 'single' or 'multi'
                currentSaveName: null,
                currentLevelIndex: 0,
                multiplayer: {
                    isHost: false,
                    roomId: null,
                    roomName: null,
                    isPrivate: false,
                    password: null,
                    peer: null,
                    connections: [],
                    localPlayerId: null,
                    playerName: '',
                    // æ¨¡æ‹Ÿå…¬å¼€æœåŠ¡å™¨åˆ—è¡¨ï¼ˆå†…å­˜ä¸­ï¼‰
                    publicRooms: {}
                }
            };

            // UI å…ƒç´ 
            const startScreen = document.getElementById('start-screen');
            const singlePanel = document.getElementById('singleplayer-panel');
            const multiPanel = document.getElementById('multiplayer-panel');
            const gameContainer = document.getElementById('game-container');
            const gameFrame = document.getElementById('game-frame');
            const deathOverlay = document.getElementById('deathOverlay');
            const chatContainer = document.getElementById('chat-container');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSend = document.getElementById('chat-send');
            

            const saveListDiv = document.getElementById('save-list');
            const newGameNameInput = document.getElementById('new-game-name');

            // å¤šäººUIå…ƒç´ 
            const privatePlus = document.getElementById('private-plus');
            const privateOptions = document.getElementById('private-options');
            const createPrivateBtn = document.getElementById('create-private');
            const joinPrivateBtn = document.getElementById('join-private');
            const createPublicBtn = document.getElementById('create-public');
            const publicServerList = document.getElementById('public-server-list');

            // æ¨¡æ€æ¡†
            const idModal = document.getElementById('id-modal');
            const playerIdInput = document.getElementById('player-id-input');
            const idError = document.getElementById('id-error');
            const confirmId = document.getElementById('confirm-id');
            const cancelId = document.getElementById('cancel-id');

            const createPrivateModal = document.getElementById('create-private-modal');
            const privateRoomName = document.getElementById('private-room-name');
            const privatePassword = document.getElementById('private-password');
            const confirmCreatePrivate = document.getElementById('confirm-create-private');
            const cancelCreatePrivate = document.getElementById('cancel-create-private');

            const joinPrivateModal = document.getElementById('join-private-modal');
            const joinPassword = document.getElementById('join-password');
            const confirmJoinPrivate = document.getElementById('confirm-join-private');
            const cancelJoinPrivate = document.getElementById('cancel-join-private');

            const createPublicModal = document.getElementById('create-public-modal');
            const publicRoomName = document.getElementById('public-room-name');
            const confirmCreatePublic = document.getElementById('confirm-create-public');
            const cancelCreatePublic = document.getElementById('cancel-create-public');

            // ---------- å·¥å…·å‡½æ•° ----------
            function showStartScreen() {
                startScreen.style.display = 'flex';
                singlePanel.style.display = 'none';
                multiPanel.style.display = 'none';
                gameContainer.style.display = 'none';
            }

            function hideAllPanels() {
                startScreen.style.display = 'none';
                singlePanel.style.display = 'none';
                multiPanel.style.display = 'none';
            }

            function validatePlayerName(name) {
                return !name.includes('ä¿Šæº');
            }

            function showIdModal(callback) {
                playerIdInput.value = 'ç©å®¶';
                idError.style.display = 'none';
                idModal.style.display = 'flex';

                const onConfirm = () => {
                    const name = playerIdInput.value.trim();
                    if (!name) {
                        alert('è¯·è¾“å…¥ID');
                        return;
                    }
                    if (!validatePlayerName(name)) {
                        idError.style.display = 'block';
                        return;
                    }
                    idModal.style.display = 'none';
                    cleanup();
                    callback(name);
                };

                const onCancel = () => {
                    idModal.style.display = 'none';
                    cleanup();
                };

                const cleanup = () => {
                    confirmId.removeEventListener('click', onConfirm);
                    cancelId.removeEventListener('click', onCancel);
                };

                confirmId.addEventListener('click', onConfirm);
                cancelId.addEventListener('click', onCancel);
            }

            // ---------- å•äººæ¸¸æˆå­˜æ¡£ ----------
            function getSaves() {
                return JSON.parse(localStorage.getItem('backroom_saves') || '[]');
            }

            function saveGame(name, levelIndex) {
    const saves = getSaves();
    const existing = saves.find(s => s.name === name);
    const levelName = LEVELS[levelIndex] || 'Unknown';
    if (existing) {
        existing.level = levelName;
        existing.levelIndex = levelIndex;  // ç¡®ä¿è¿™é‡Œä¿å­˜çš„æ˜¯æ•°å­—ç´¢å¼•
        existing.time = Date.now();
    } else {
        saves.push({ 
            name, 
            level: levelName, 
            levelIndex: levelIndex,  // æ–°å­˜æ¡£ä¹Ÿè¦ä¿å­˜æ•°å­—ç´¢å¼•
            time: Date.now() 
        });
    }
    localStorage.setItem('backroom_saves', JSON.stringify(saves));
}

            function deleteSave(name) {
                const saves = getSaves();
                const newSaves = saves.filter(s => s.name !== name);
                localStorage.setItem('backroom_saves', JSON.stringify(newSaves));
                loadSaveList();
            }

            function copySave(originalName, levelIndex, levelName) {
                const saves = getSaves();
                let newName = '';
                let counter = 1;
                while (true) {
                    newName = `${originalName}(${counter})`;
                    if (!saves.some(s => s.name === newName)) break;
                    counter++;
                }
                saves.push({ name: newName, level: levelName, levelIndex, time: Date.now() });
                localStorage.setItem('backroom_saves', JSON.stringify(saves));
                loadSaveList();
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function loadSaveList() {
                const saves = getSaves();
                saveListDiv.innerHTML = '';
                if (saves.length === 0) {
                    saveListDiv.innerHTML = '<div style="text-align:center; color:#333; padding:2rem;">æš‚æ— å­˜æ¡£</div>';
                    return;
                }
                saves.sort((a,b) => b.time - a.time);
                saves.forEach(save => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'save-item';
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'save-content';
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'save-info';
                    infoDiv.innerHTML = `
                        <div class="save-name">${escapeHtml(save.name)}</div>
                        <div class="save-detail">å…³å¡: ${escapeHtml(save.level)} | ${new Date(save.time).toLocaleString()}</div>
                    `;
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'save-actions';
                    
                    const copyBtn = document.createElement('div');
                    copyBtn.className = 'action-btn copy-btn';
                    copyBtn.textContent = 'ğŸ“„';
                    copyBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        copySave(save.name, save.levelIndex || 0, save.level);
                    });
                    
                    const deleteBtn = document.createElement('div');
                    deleteBtn.className = 'action-btn delete-btn';
                    deleteBtn.textContent = 'âŒ';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm(`åˆ é™¤å­˜æ¡£â€œ${save.name}â€ï¼Ÿ`)) deleteSave(save.name);
                    });
                    
                    actionsDiv.appendChild(copyBtn);
                    actionsDiv.appendChild(deleteBtn);
                    contentDiv.appendChild(infoDiv);
                    contentDiv.appendChild(actionsDiv);
                    
                    contentDiv.addEventListener('click', () => {
                        gameState.currentSaveName = save.name;
                        gameState.currentLevelIndex = save.levelIndex || 0;
                        startSingleGame();
                    });
                    
                    itemDiv.appendChild(contentDiv);
                    saveListDiv.appendChild(itemDiv);
                });
            }

            // ---------- æ¸¸æˆå¯åŠ¨ ----------
            function startSingleGame() {
                gameState.currentGameType = 'single';
                hideAllPanels();
                gameContainer.style.display = 'block';
                chatContainer.style.display = 'none';
                
                loadLevel(gameState.currentLevelIndex);
            }

            function startMultiplayerGame() {
    gameState.currentGameType = 'multi';
    hideAllPanels();
    gameContainer.style.display = 'block';
    chatContainer.style.display = 'flex';
    // å¤šäººæ¸¸æˆä»ç¬¬ä¸€å…³å¼€å§‹
    loadLevel(0);
}

            function loadLevel(index) {
                if (index >= LEVELS.length) {
                    alert('æ­å–œï¼ä½ å®Œæˆäº†æ‰€æœ‰å…³å¡ï¼');
                    showStartScreen();
                    return;
                }
                const levelFile = LEVELS[index];
                gameFrame.src = levelFile;
            }

            // ---------- å¤„ç† iframe æ¶ˆæ¯ ----------
            window.addEventListener('message', (event) => {
                const data = event.data;
                if (!data || typeof data !== 'object') return;

                switch (data.type) {
                    case 'levelComplete':
    gameState.currentLevelIndex++;
    if (gameState.currentGameType === 'single' && gameState.currentSaveName) {
        saveGame(gameState.currentSaveName, gameState.currentLevelIndex); // æ·»åŠ è¿™è¡Œ
    }
    loadLevel(gameState.currentLevelIndex);
    break;
                    case 'playerDeath':
                        deathOverlay.style.display = 'block';
                        setTimeout(() => {
                            deathOverlay.style.display = 'none';
                            showStartScreen();
                        }, 1000);
                        break;
                }
            });

            // ---------- å¤šäººç½‘ç»œï¼ˆç®€åŒ–ç‰ˆï¼Œä½¿ç”¨å†…å­˜æ¨¡æ‹Ÿå…¬å¼€æœåŠ¡å™¨ï¼‰----------
            function updatePublicServerList() {
                publicServerList.innerHTML = '';
                for (let roomId in gameState.multiplayer.publicRooms) {
                    const room = gameState.multiplayer.publicRooms[roomId];
                    const div = document.createElement('div');
                    div.className = 'server-item';
                    div.innerHTML = `
                        <div class="server-info">
                            <div class="server-name">${escapeHtml(room.name)}</div>
                            <div class="server-players">ğŸ‘¥ ${room.playerCount}/4</div>
                        </div>
                        <div class="join-indicator">ç‚¹å‡»åŠ å…¥</div>
                    `;
                    div.addEventListener('click', () => {
                        joinPublicRoom(roomId, room);
                    });
                    publicServerList.appendChild(div);
                }
            }

            function joinPublicRoom(roomId, room) {
    showIdModal((playerName) => {
        gameState.multiplayer.isHost = false;
        gameState.multiplayer.roomId = roomId;
        gameState.multiplayer.roomName = room.name;
        gameState.multiplayer.isPrivate = false;
        gameState.multiplayer.playerName = playerName;

        // åŒæ ·ä½¿ç”¨ STUN+TURN é…ç½®
        const peer = new Peer({
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' },
                    {
                        urls: 'turn:turn.ztun.org:3478',
                        username: 'free',
                        credential: 'free'
                    },
                    {
                        urls: 'turn:turn.ztun.org:3478?transport=tcp',
                        username: 'free',
                        credential: 'free'
                    }
                ]
            }
        });
        
        peer.on('open', (id) => {
            gameState.multiplayer.localPlayerId = id;
            
            // æ˜¾ç¤ºè¿æ¥ä¸­æç¤º
            const connectingDiv = document.createElement('div');
            connectingDiv.id = 'connecting-toast';
            connectingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: black;
                color: white;
                padding: 1rem 2rem;
                border-radius: 2rem;
                z-index: 3000;
            `;
            connectingDiv.textContent = 'æ­£åœ¨è¿æ¥æˆ¿é—´...';
            document.body.appendChild(connectingDiv);

            // è¿æ¥æ—¶å¸¦ä¸Šç©å®¶åä½œä¸ºmetadata
            const conn = peer.connect(roomId, {
                reliable: true,
                serialization: 'json',
                metadata: { playerName: playerName }
            });

            const timeout = setTimeout(() => {
                document.body.removeChild(connectingDiv);
                alert('è¿æ¥è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
                peer.destroy();
            }, 10000);

            conn.on('open', () => {
                clearTimeout(timeout);
                document.body.removeChild(connectingDiv);
                
                gameState.multiplayer.connections = [conn];
                gameState.multiplayer.peer = peer;
                setupConnection(conn);
                startMultiplayerGame();
            });

            conn.on('error', (err) => {
                clearTimeout(timeout);
                document.body.removeChild(connectingDiv);
                alert('è¿æ¥å¤±è´¥ï¼š' + err.message);
                peer.destroy();
            });
        });

        peer.on('error', (err) => {
            alert('è¿æ¥å¤±è´¥ï¼š' + err.message);
            console.error('Peer error:', err);
            showStartScreen();
        });
    });
}

            function createPublicRoom(roomName) {
    showIdModal((playerName) => {
        gameState.multiplayer.isHost = true;
        gameState.multiplayer.roomName = roomName;
        gameState.multiplayer.isPrivate = false;
        gameState.multiplayer.playerName = playerName;

        // ä½¿ç”¨ STUN+TURN é…ç½®ï¼Œç¡®ä¿è·¨äº’è”ç½‘è¿æ¥
        const peer = new Peer({
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' },
                    {
                        urls: 'turn:turn.ztun.org:3478',
                        username: 'free',
                        credential: 'free'
                    },
                    {
                        urls: 'turn:turn.ztun.org:3478?transport=tcp',
                        username: 'free',
                        credential: 'free'
                    }
                ]
            }
        });
        
        peer.on('open', (id) => {
            gameState.multiplayer.roomId = id;
            gameState.multiplayer.localPlayerId = id;
            gameState.multiplayer.peer = peer;

            // æ·»åŠ åˆ°å…¬å¼€åˆ—è¡¨
            gameState.multiplayer.publicRooms[id] = {
                name: roomName,
                hostId: id,
                playerCount: 1
            };
            updatePublicServerList();

            // ç›‘å¬æ–°è¿æ¥
            peer.on('connection', (conn) => {
                gameState.multiplayer.connections.push(conn);
                setupConnection(conn);
                
                // æ›´æ–°äººæ•°
                gameState.multiplayer.publicRooms[id].playerCount = 
                    gameState.multiplayer.connections.length + 1;
                updatePublicServerList();

                // å‘é€æ¬¢è¿æ¶ˆæ¯
                const welcomeMsg = {
                    type: 'system',
                    msg: `${conn.metadata?.playerName || 'æ–°ç©å®¶'} åŠ å…¥äº†æˆ¿é—´`
                };
                gameState.multiplayer.connections.forEach(c => c.send(welcomeMsg));
            });

            startMultiplayerGame();
        });

        peer.on('error', (err) => {
            alert('åˆ›å»ºæˆ¿é—´å¤±è´¥ï¼š' + err.message);
            console.error('Peer error:', err);
            showStartScreen();
        });
    });
}

            function createPrivateRoom(roomName, password) {
    showIdModal((playerName) => {
        gameState.multiplayer.isHost = true;
        gameState.multiplayer.roomName = roomName;
        gameState.multiplayer.isPrivate = true;
        gameState.multiplayer.password = password;
        gameState.multiplayer.playerName = playerName;

        // é…ç½® STUN + TURN æœåŠ¡å™¨ï¼Œå®ç°è·¨äº’è”ç½‘è”æœº
        const peer = new Peer({
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' },
                    // å…è´¹å…¬å…± TURN æœåŠ¡å™¨ï¼Œç”¨äºæ•°æ®è½¬å‘
                    {
                        urls: 'turn:turn.ztun.org:3478',
                        username: 'free',
                        credential: 'free'
                    },
                    {
                        urls: 'turn:turn.ztun.org:3478?transport=tcp',
                        username: 'free',
                        credential: 'free'
                    },
                    {
                        urls: 'turns:turn.ztun.org:5349',
                        username: 'free',
                        credential: 'free'
                    }
                ]
            }
        });
        
        peer.on('open', (id) => {
            console.log('ç§æœ‰æœåŠ¡å™¨åˆ›å»ºæˆåŠŸï¼ŒPeer ID:', id);
            gameState.multiplayer.roomId = id;
            gameState.multiplayer.localPlayerId = id;
            gameState.multiplayer.peer = peer;

            // æ˜¾ç¤ºæˆ¿é—´IDæ¨¡æ€æ¡†ï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
            try {
                showRoomIdModal(id, roomName, password);
            } catch (e) {
                console.error('æ˜¾ç¤ºæˆ¿é—´IDæ¨¡æ€æ¡†å¤±è´¥:', e);
                alert('æˆ¿é—´åˆ›å»ºæˆåŠŸï¼Œä½†æ˜¾ç¤ºIDå¤±è´¥ã€‚ä½ çš„æˆ¿é—´IDæ˜¯: ' + id);
            }

            peer.on('connection', (conn) => {
                console.log('æ”¶åˆ°æ–°è¿æ¥');
                // éªŒè¯å¯†ç 
                conn.on('data', (data) => {
                    if (data.type === 'auth') {
                        if (data.password === password) {
                            conn.send({ type: 'auth_success' });
                            gameState.multiplayer.connections.push(conn);
                            setupConnection(conn);
                            
                            // é€šçŸ¥æ‰€æœ‰ç©å®¶æœ‰æ–°ç©å®¶åŠ å…¥
                            const joinMsg = {
                                type: 'system',
                                msg: `${data.playerName} åŠ å…¥äº†æˆ¿é—´`
                            };
                            gameState.multiplayer.connections.forEach(c => c.send(joinMsg));
                            // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯å‡½æ•°è°ƒç”¨
                            if (typeof addSystemMessage === 'function') {
                                addSystemMessage(`${data.playerName} åŠ å…¥äº†æˆ¿é—´`);
                            } else {
                                console.log(`${data.playerName} åŠ å…¥äº†æˆ¿é—´`);
                            }
                        } else {
                            conn.send({ type: 'auth_fail' });
                            conn.close();
                        }
                    }
                });
            });

            // ç¡®ä¿æ¸¸æˆå¯åŠ¨
            console.log('å‡†å¤‡å¯åŠ¨å¤šäººæ¸¸æˆ');
            startMultiplayerGame();
        });

        peer.on('error', (err) => {
            console.error('PeerJS é”™è¯¯:', err);
            alert('è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚é”™è¯¯ä¿¡æ¯: ' + err.message);
            showStartScreen();
        });
    });
}

            function joinPrivateRoom(password) {
    // å…ˆè¾“å…¥æˆ¿é—´ID
    const hostId = prompt('è¯·è¾“å…¥æˆ¿ä¸»çš„æˆ¿é—´ID');
    if (!hostId) return;

    showIdModal((playerName) => {
        gameState.multiplayer.isHost = false;
        gameState.multiplayer.roomId = hostId;
        gameState.multiplayer.isPrivate = true;
        gameState.multiplayer.password = password;
        gameState.multiplayer.playerName = playerName;

        // åŒæ ·é…ç½® STUN + TURN æœåŠ¡å™¨
        const peer = new Peer({
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' },
                    {
                        urls: 'turn:turn.ztun.org:3478',
                        username: 'free',
                        credential: 'free'
                    },
                    {
                        urls: 'turn:turn.ztun.org:3478?transport=tcp',
                        username: 'free',
                        credential: 'free'
                    },
                    {
                        urls: 'turns:turn.ztun.org:5349',
                        username: 'free',
                        credential: 'free'
                    }
                ]
            }
        });
        
        peer.on('open', (id) => {
            gameState.multiplayer.localPlayerId = id;
            
            // æ˜¾ç¤ºè¿æ¥ä¸­æç¤º
            const connectingDiv = document.createElement('div');
            connectingDiv.id = 'connecting-toast';
            connectingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: black;
                color: white;
                padding: 1rem 2rem;
                border-radius: 2rem;
                z-index: 3000;
            `;
            connectingDiv.textContent = 'æ­£åœ¨è¿æ¥æˆ¿é—´...';
            document.body.appendChild(connectingDiv);

            const conn = peer.connect(hostId, {
                reliable: true,
                serialization: 'json'
            });

            const timeout = setTimeout(() => {
                document.body.removeChild(connectingDiv);
                alert('è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æˆ¿é—´IDæ˜¯å¦æ­£ç¡®');
                peer.destroy();
            }, 10000);

            conn.on('open', () => {
                clearTimeout(timeout);
                document.body.removeChild(connectingDiv);
                
                // å‘é€è®¤è¯ä¿¡æ¯ï¼Œå¸¦ä¸Šç©å®¶å
                conn.send({ 
                    type: 'auth', 
                    password: password,
                    playerName: playerName 
                });
                
                gameState.multiplayer.connections = [conn];
                gameState.multiplayer.peer = peer;
                setupConnection(conn);
                
                // ç­‰å¾…è®¤è¯ç»“æœ
                conn.once('data', (data) => {
                    if (data.type === 'auth_success') {
                        startMultiplayerGame();
                    } else if (data.type === 'auth_fail') {
                        alert('å¯†ç é”™è¯¯');
                        peer.destroy();
                        showStartScreen();
                    }
                });
            });

            conn.on('error', (err) => {
                clearTimeout(timeout);
                document.body.removeChild(connectingDiv);
                alert('è¿æ¥å¤±è´¥ï¼š' + err.message);
                peer.destroy();
            });
        });

        peer.on('error', (err) => {
            alert('æ— æ³•åˆ›å»ºè¿æ¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            console.error('Peer error:', err);
            showStartScreen();
        });
    });
}

            function setupConnection(conn) {
                conn.on('data', (data) => {
                    if (data.type === 'chat') {
                        addChatMessage(data.sender, data.msg);
                        if (gameState.multiplayer.isHost) {
                            gameState.multiplayer.connections.forEach(c => {
                                if (c !== conn) c.send(data);
                            });
                        }
                    } else if (data.type === 'auth' && gameState.multiplayer.isHost) {
                        if (data.password === gameState.multiplayer.password) {
                            conn.send({ type: 'auth_success' });
                        } else {
                            conn.send({ type: 'auth_fail' });
                            conn.close();
                        }
                    }
                });

                conn.on('close', () => {
                    // ä»connectionsä¸­ç§»é™¤
                    const index = gameState.multiplayer.connections.indexOf(conn);
                    if (index > -1) gameState.multiplayer.connections.splice(index, 1);
                    // å¦‚æœæ˜¯å…¬å¼€æˆ¿é—´æˆ¿ä¸»ï¼Œæ›´æ–°äººæ•°
                    if (gameState.multiplayer.isHost && !gameState.multiplayer.isPrivate) {
                        const room = gameState.multiplayer.publicRooms[gameState.multiplayer.roomId];
                        if (room) {
                            room.playerCount = gameState.multiplayer.connections.length + 1;
                            updatePublicServerList();
                        }
                    }
                });
            }

            function addChatMessage(sender, msg) {
    const div = document.createElement('div');
    div.innerHTML = `<b>${escapeHtml(sender)}:</b> ${escapeHtml(msg)}`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // å¦‚æœå·²ç»æœ‰å®šæ—¶å™¨ï¼Œå…ˆæ¸…é™¤
    if (window.clearChatTimer) {
        clearTimeout(window.clearChatTimer);
    }
    
    // è®¾ç½®æ–°å®šæ—¶å™¨ï¼Œ20ç§’åæ¸…ç©ºå¯¹è¯æ¡†
    window.clearChatTimer = setTimeout(() => {
        chatMessages.innerHTML = '';
        // å¯ä»¥åŠ ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯æç¤ºï¼ˆå¯é€‰ï¼‰
        // const sysMsg = document.createElement('div');
        // sysMsg.innerHTML = '<i>--- å¯¹è¯å·²æ¸…ç©º ---</i>';
        // chatMessages.appendChild(sysMsg);
    }, 20000); // 20000æ¯«ç§’ = 20ç§’
}
function addSystemMessage(msg) {
    const div = document.createElement('div');
    div.innerHTML = `<i style="color: #666;">${escapeHtml(msg)}</i>`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

            // ---------- äº‹ä»¶ç»‘å®š ----------
            document.getElementById('singleplayer-btn').addEventListener('click', () => {
                startScreen.style.display = 'none';
                singlePanel.style.display = 'block';
                loadSaveList();
            });

            document.getElementById('multiplayer-btn').addEventListener('click', () => {
                startScreen.style.display = 'none';
                multiPanel.style.display = 'block';
                updatePublicServerList();
            });
// å®šæœŸæ¸…ç†å¯èƒ½å¤±æ•ˆçš„æˆ¿é—´ï¼ˆæ¯”å¦‚å´©æºƒæ²¡æ¥å¾—åŠåˆ é™¤çš„ï¼‰
setInterval(() => {
    // è¿™ä¸ªå‡½æ•°åªåœ¨æˆ¿ä¸»è‡ªå·±è¿™é‡Œè¿è¡Œï¼Œæ‰€ä»¥ä¸éœ€è¦æ¸…ç†åˆ«äººçš„æˆ¿é—´
    // ä½†æˆ‘ä»¬å¯ä»¥æ£€æŸ¥ä¸€ä¸‹è‡ªå·±çš„æˆ¿é—´æ˜¯å¦è¿˜åœ¨
}, 30000); // 30ç§’ä¸€æ¬¡
            document.getElementById('back-from-single').addEventListener('click', showStartScreen);
            document.getElementById('back-from-multi').addEventListener('click', showStartScreen);

            document.getElementById('start-new-game').addEventListener('click', () => {
                const name = newGameNameInput.value.trim();
                if (!name) { alert('è¯·è¾“å…¥æ¸¸æˆåç§°'); return; }
                const saves = getSaves();
                if (saves.some(s => s.name === name)) { alert('åç§°å·²å­˜åœ¨'); return; }
                gameState.currentSaveName = name;
                gameState.currentLevelIndex = 0;
                saveGame(name, 0);
                startSingleGame();
            });

            privatePlus.addEventListener('click', () => {
                privateOptions.style.display = privateOptions.style.display === 'flex' ? 'none' : 'flex';
            });

            createPrivateBtn.addEventListener('click', () => {
                privateOptions.style.display = 'none';
                createPrivateModal.style.display = 'flex';
            });

            joinPrivateBtn.addEventListener('click', () => {
                privateOptions.style.display = 'none';
                joinPrivateModal.style.display = 'flex';
            });

            confirmCreatePrivate.addEventListener('click', () => {
                const name = privateRoomName.value.trim();
                const pwd = privatePassword.value.trim();
                if (!name || !pwd) { alert('è¯·å¡«å†™å®Œæ•´'); return; }
                createPrivateModal.style.display = 'none';
                privateRoomName.value = '';
                privatePassword.value = '';
                createPrivateRoom(name, pwd);
            });

            cancelCreatePrivate.addEventListener('click', () => {
                createPrivateModal.style.display = 'none';
            });

            confirmJoinPrivate.addEventListener('click', () => {
                const pwd = joinPassword.value.trim();
                if (!pwd) { alert('è¯·è¾“å…¥å¯†ç '); return; }
                joinPrivateModal.style.display = 'none';
                joinPassword.value = '';
                joinPrivateRoom(pwd);
            });

            cancelJoinPrivate.addEventListener('click', () => {
                joinPrivateModal.style.display = 'none';
            });

            createPublicBtn.addEventListener('click', () => {
                createPublicModal.style.display = 'flex';
            });

            confirmCreatePublic.addEventListener('click', () => {
                const name = publicRoomName.value.trim();
                if (!name) { alert('è¯·è¾“å…¥æˆ¿é—´åç§°'); return; }
                createPublicModal.style.display = 'none';
                publicRoomName.value = '';
                createPublicRoom(name);
            });

            cancelCreatePublic.addEventListener('click', () => {
                createPublicModal.style.display = 'none';
            });

            chatSend.addEventListener('click', () => {
                const msg = chatInput.value.trim();
                if (!msg) return;
                const sender = gameState.multiplayer.playerName || 'ç©å®¶';
                addChatMessage(sender, msg);
                const data = { type: 'chat', sender, msg };
                gameState.multiplayer.connections.forEach(conn => conn.send(data));
                chatInput.value = '';
            });

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') chatSend.click();
            });

            

            // çª—å£å…³é—­æ¸…ç†
            window.addEventListener('beforeunload', () => {
    // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œä»å…¬å¼€åˆ—è¡¨ä¸­åˆ é™¤æˆ¿é—´
    if (gameState.multiplayer.isHost && !gameState.multiplayer.isPrivate) {
        const roomId = gameState.multiplayer.roomId;
        if (roomId && gameState.multiplayer.publicRooms[roomId]) {
            delete gameState.multiplayer.publicRooms[roomId];
            // å¦‚æœæœ‰å…¶ä»–ç©å®¶ï¼Œé€šçŸ¥ä»–ä»¬æˆ¿ä¸»å·²ç¦»å¼€
            gameState.multiplayer.connections.forEach(conn => {
                conn.send({ type: 'system', msg: 'æˆ¿ä¸»å·²ç¦»å¼€ï¼Œæˆ¿é—´å³å°†å…³é—­' });
                setTimeout(() => conn.close(), 1000);
            });
        }
    }
    
    if (gameState.multiplayer.peer) {
        gameState.multiplayer.peer.destroy();
    }
});
            // åˆå§‹åŒ–
            showStartScreen();
        })();
    </script>
</body>
</html>